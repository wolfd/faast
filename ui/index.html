<html>
  <head>
    <title>Hello React</title>
    <script src="http://fb.me/react-0.12.2.js"></script>
    <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
    <script src="libs/jquery.ajax.fake.js"></script>
    <title>FriendCast</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    <div id="container"></div>
    <script type="text/jsx">
      var Router = ReactRouter;
      var DefaultRoute = Router.DefaultRoute;
      var NotFoundRoute = Router.NotFoundRoute;
      var Link = Router.Link;
      var Route = Router.Route;
      var RouteHandler = Router.RouteHandler;

      var LOGGED_IN = false;
      var TOKEN = "";

      var API_ENDPOINT = "http://localhost:8000/";

      $.ajax.fake.registerWebservice('http://api.friendcast.io/cast', function(data) {
          return [{
              "success": "true"
          }]
      });

      $.ajax.fake.registerWebservice('http://api.friendcast.io/reel', function(data) {
          return [{
              "friends": ""
          }]
      });

      var LoginButton = React.createClass({
        componentDidMount: function() {
          window.fbAsyncInit = function() {
            FB.init({
              appId      : '1395623010744563',
              cookie     : true,  // enable cookies to allow the server to access
                                // the session
              xfbml      : true,  // parse social plugins on this page
              version    : 'v2.2'
            });

            FB.getLoginStatus(function(response) {
              console.log("getLoginStatus");
              this.statusChangeCallback(response);
            }.bind(this));
          }.bind(this);

          // Load the SDK asynchronously
          (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
          }(document, 'script', 'facebook-jssdk'));
        },

        // This is called with the results from from FB.getLoginStatus().
        statusChangeCallback: function(response) {
          console.log('statusChangeCallback');
          console.log(response);
          // The response object is returned with a status field that lets the
          // app know the current login status of the person.
          // Full docs on the response object can be found in the documentation
          // for FB.getLoginStatus().
          if (response.status === 'connected') {
            this.props.onLogin(FB.getAccessToken());
          } else if (response.status === 'not_authorized') {
            // The person is logged into Facebook, but not your app.
            document.getElementById('status').innerHTML = 'Please log ' +
              'into this app.';
          } else {
            // The person is not logged into Facebook, so we're not sure if
            // they are logged into this app or not.
            document.getElementById('status').innerHTML = 'Please log ' +
            'into Facebook.';
          }
        },

        // This function is called when someone finishes with the Login
        // Button.  See the onlogin handler attached to it in the sample
        // code below.
        checkLoginState: function() {
          console.log("checkLoginState");
          FB.getLoginStatus(function(response) {
            this.statusChangeCallback(response);
          }.bind(this));
        },

        handleClick: function() {
          FB.login(this.checkLoginState());
        },

        render: function() {
          return (
            <div className="LoginButton">
              <a href="#" onClick={this.handleClick}>Login</a>
              <div id="status">
              </div>
            </div>
          );
        }
      });

      var FreeBox = React.createClass({
        onLogin: function(token) {
          LOGGED_IN = true;
          TOKEN = token;
          this.setState({
            loggedIn : true,
            token : token
          });
          console.log("logged in");
        },

        getInitialState: function() {
          return {loggedIn: LOGGED_IN, token: TOKEN};
        },

        render: function() {
          if(this.state.loggedIn) {
            return (
              <div className="freeBox">
                <FreeButton when="now" />
                <FreeButton when="later" />
              </div>
            );
          } else {
            return (
              <LoginButton onLogin={this.onLogin} />
            );
          }
        }
      });

      var LogoBox = React.createClass({
        render: function() {
          return (
            <div className="LogoBox">
              Friend<b>Cast</b>
            </div>
          );
        }
      });

      var FreeButton = React.createClass({
        render: function() {
          return (
            <Link to={"/cast/" + this.props.when} >
              <button className="FreeButton btn btn-primary btn-lg btn-block" type="button" id={this.props.when}>
                {this.props.when}
              </button>
            </Link>
          );
        }
      });

      var App = React.createClass({
        render: function() {
          return (
            <div className="App">
              <RouteHandler/>
            </div>
          );
        }
      });

      var Index = React.createClass({
        render: function() {
          return (
            <div className="Index">
              <LogoBox />
              <FreeBox />
            </div>
          );
        }
      });

      /////////////

      var Cast = React.createClass({
        mixins: [Router.State],

        getInitialState: function() {
          var startTime = "";
          if(this.getParams().when === "now") {
            startTime = new Date().getHours();
          }
          return {
            startTime: startTime,
            endTime: (startTime + 1) % 24,
            blurb: ""
          };
        },

        goFish: function() {
          var send = {
            startTime: this.state.startTime,
            endTime: this.state.endTime,
            blurb: this.state.blurb
          }

          $.ajax({
            type: "POST",
            fake: true,
            url: API_ENDPOINT + "/cast",
            data: data,
            dataType: 'json',
            success: function(data) {
              this.setState({data: data});
            }.bind(this),
            error: function(xhr, status, err) {
              console.error(this.props.url, status, err.toString());
            }.bind(this)
          });
        },

        render: function() {
          return (
            <div className="Cast">
              {this.getParams().when}
              <TimeBox onChange={this.updateStartTime} />
              <TimeBox onChange={this.updateEndTime}/>
              <BlurbBox onChange={this.updateBlurb}/>
              <SubmitBox submitIt={this.goFish}/>
            </div>
          );
        }
      });

      var TimeBox = React.createClass({
        render: function() {
          var timeNow = new Date()
          var hour = timeNow.getHours();
          var numRows = 24;
          var rows = [];
          for (var i=0; i < numRows; i++) {
            var thisHour = (hour + i) % 24;
            var ampm = "";
            if(thisHour > 12) {
              ampm = (thisHour - 12) + " PM";
            } else if(thisHour === 0) {
              ampm = "12 AM";
            } else if(thisHour === 12) {
              ampm = "12 PM";
            } else {
              ampm = thisHour + " AM";
            } 
            rows.push(<option value={(hour + i) % 24}>{ampm}</option>);
          }
          return <select className="TimeBox">{rows}</select>;

        }
      });

      var BlurbBox = React.createClass({
        render: function() {
          return (
            <div className="BlurbBox">What do you want to do?</div>
          );
        }
      });

      var SubmitBox = React.createClass({
        render: function() {
          return (
            <Link to="/reel" onClick={this.props.submitIt}>
              <button className="SubmitBox btn btn-primary btn-lg btn-block" type="button">
                See who's around
              </button>
            </Link>
          );
        }
      });

      /////////////

      var Reel = React.createClass({
        render: function() {
          return (
            <div className="Reel">
              I'M REEELING
            </div>
          );
        }
      });

      var NotFound = React.createClass({
        render: function() {
          return (
            <div className="NotFound"></div>
          );
        }
      });

      var routes = (
        <Route name="app" handler={App} path="/">
          <DefaultRoute handler={Index} />
          <Route name="cast" handler={Cast} path="/cast/:when"/>
          <Route name="reel" handler={Reel} path="/reel"/>
          <NotFoundRoute handler={NotFound} />
        </Route>
      );

      //Router.HistoryLocation,
      Router.run(routes, function (Handler) {
        React.render(<Handler/>, document.body);
      });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-router/0.11.6/react-router.min.js"></script>
    <script src=""></script>
  </body>
</html>